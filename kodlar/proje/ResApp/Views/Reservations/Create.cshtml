@model ReservationFormViewModel
@{
    ViewData["Title"] = "Rezervasyon Oluştur";
    var today = DateTime.Today.ToString("yyyy-MM-dd");
}

<div class="mb-4">
    <a asp-controller="Books" asp-action="Details" asp-route-id="@Model.BookId" class="btn btn-link">&larr; Kitap Detayına Geri Dön</a>
</div>

<div class="row g-4">
    <div class="col-md-7">
        <div class="card">
            <div class="card-body">
                <h2 class="card-title">Kitap: @Model.BookTitle</h2>
                <p class="text-muted">Lütfen başlangıç ve bitiş tarihlerini seçin. Rezervasyon süresi en fazla 7 gündür.</p>

                <form asp-action="Create" method="post" class="row g-3">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
                    <input type="hidden" asp-for="BookId" />
                    <input type="hidden" asp-for="BookTitle" />
                    <div class="col-md-6">
                        <label class="form-label" asp-for="StartDate"></label>
                        <input class="form-control" asp-for="StartDate" type="date" min="@today" />
                        <span class="text-danger" asp-validation-for="StartDate"></span>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" asp-for="EndDate"></label>
                        <input class="form-control" asp-for="EndDate" type="date" min="@today" />
                        <span class="text-danger" asp-validation-for="EndDate"></span>
                    </div>
                    <div class="col-12 text-end">
                        <button type="submit" id="submitButton" class="btn btn-primary">Rezervasyon Talebini Gönder</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-5">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Bu Kitabın Aktif Rezervasyonları</h5>
                @if (Model.ExistingReservations.Any())
                {
                    <ul class="list-group list-group-flush">
                        @foreach (var r in Model.ExistingReservations)
                        {
                            <li class="list-group-item">
                                @r.StartDate.ToShortDateString() &mdash; @r.EndDate.ToShortDateString()
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p class="text-muted">Bu kitap için aktif bir rezervasyon bulunmuyor.</p>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const startDateInput = document.getElementById('StartDate');
            const endDateInput = document.getElementById('EndDate');
            const submitButton = document.getElementById('submitButton');

            const existingReservations = @Html.Raw(Json.Serialize(
                Model.ExistingReservations.Select(r => new { start = r.StartDate.ToString("yyyy-MM-dd"), end = r.EndDate.ToString("yyyy-MM-dd") })
            ));

            function validateDates() {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);

                let isValid = true;
                let message = "";

                if (!startDateInput.value || !endDateInput.value) {
                    isValid = false;
                }
                
                if (endDate < startDate) {
                    message = "Bitiş tarihi başlangıç tarihinden önce olamaz.";
                    isValid = false;
                }

                const diffDays = (endDate - startDate) / (1000 * 60 * 60 * 24);
                if (diffDays > 7) {
                    message = "Rezervasyon süresi en fazla 7 gün olabilir.";
                    isValid = false;
                }
                
                for (const res of existingReservations) {
                    const existingStart = new Date(res.start);
                    const existingEnd = new Date(res.end);
                    if (startDate <= existingEnd && endDate >= existingStart) {
                        message = "Seçtiğiniz tarih aralığı mevcut bir rezervasyon ile çakışıyor.";
                        isValid = false;
                        break;
                    }
                }

                const validationSummary = document.querySelector('[data-valmsg-summary="true"]');
                if (!isValid) {
                    submitButton.disabled = true;
                    if (validationSummary) {
                        validationSummary.innerHTML = '<ul><li>' + message + '</li></ul>';
                        validationSummary.classList.remove('validation-summary-valid');
                        validationSummary.classList.add('validation-summary-errors');
                    }
                } else {
                    submitButton.disabled = false;
                     if (validationSummary) {
                        validationSummary.innerHTML = '';
                        validationSummary.classList.remove('validation-summary-errors');
                        validationSummary.classList.add('validation-summary-valid');
                    }
                }
            }

            startDateInput.addEventListener('change', validateDates);
            endDateInput.addEventListener('change', validateDates);
            
            validateDates();
        });
    </script>
}
